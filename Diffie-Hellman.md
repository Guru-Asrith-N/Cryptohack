# Diffie-Hellman

## Starter 

### Diffie-Hellman Starter 1

`g*d mod 991 =1` is the same as `g*d = 1 mod 991`   
we have to find d    
```
p = 991
g = 209 
d = pow(g,-1,991)

print (d)
```
`flag - 569`   

### Diffie-Hellman Starter 2  

found this website for calculating primitive roots    
http://www.bluetulip.org/2014/programs/primitive.html  
`flag - 7`

### Diffie-Hellman starter 3

```
g = 2
p = 2410312426921032588552076022197566074856950548502459942654116941958108831682612228890093858261341614673227141477904012196503648957050582631942730706805009223062734745341073406696246014589361659774041027169249453200378729434170325843778659198143763193776859869524088940195577346119843545301547043747207749969763750084308926339295559968882457872412993810129130294592999947926365264059284647209730384947211681434464714438488520940127459844288859336526896320919633919
a = 972107443837033796245864316200458246846904598488981605856765890478853088246897345487328491037710219222038930943365848626194109830309179393018216763327572120124760140018038673999837643377590434413866611132403979547150659053897355593394492586978400044375465657296027592948349589216415363722668361328689588996541370097559090335137676411595949335857341797148926151694299575970292809805314431447043469447485957669949989090202320234337890323293401862304986599884732815

m = pow (g,a,p)
print (m)
```
`flag - 1806857697840726523322586721820911358489420128129248078673933653533930681676181753849411715714173604352323556558783759252661061186320274214883104886050164368129191719707402291577330485499513522368289395359523901406138025022522412429238971591272160519144672389532393673832265070057319485399793101182682177465364396277424717543434017666343807276970864475830391776403957550678362368319776566025118492062196941451265638054400177248572271342548616103967411990437357924`

### Diffie-Hellman starter 4

we know that `A = g^a mod p` and `B = g^b mod p`   
shared secret can be found using `A^b mod p` or `B^a mod p` or `g^ab mod p`    
```
g = 2
p = 2410312426921032588552076022197566074856950548502459942654116941958108831682612228890093858261341614673227141477904012196503648957050582631942730706805009223062734745341073406696246014589361659774041027169249453200378729434170325843778659198143763193776859869524088940195577346119843545301547043747207749969763750084308926339295559968882457872412993810129130294592999947926365264059284647209730384947211681434464714438488520940127459844288859336526896320919633919
A = 70249943217595468278554541264975482909289174351516133994495821400710625291840101960595720462672604202133493023241393916394629829526272643847352371534839862030410331485087487331809285533195024369287293217083414424096866925845838641840923193480821332056735592483730921055532222505605661664236182285229504265881752580410194731633895345823963910901731715743835775619780738974844840425579683385344491015955892106904647602049559477279345982530488299847663103078045601
b = 12019233252903990344598522535774963020395770409445296724034378433497976840167805970589960962221948290951873387728102115996831454482299243226839490999713763440412177965861508773420532266484619126710566414914227560103715336696193210379850575047730388378348266180934946139100479831339835896583443691529372703954589071507717917136906770122077739814262298488662138085608736103418601750861698417340264213867753834679359191427098195887112064503104510489610448294420720
B = 518386956790041579928056815914221837599234551655144585133414727838977145777213383018096662516814302583841858901021822273505120728451788412967971809038854090670743265187138208169355155411883063541881209288967735684152473260687799664130956969450297407027926009182761627800181901721840557870828019840218548188487260441829333603432714023447029942863076979487889569452186257333512355724725941390498966546682790608125613166744820307691068563387354936732643569654017172

m = pow (A,b,p)
print (m)
```
`flag - 1174130740413820656533832746034841985877302086316388380165984436672307692443711310285014138545204369495478725102882673427892104539120952393788961051992901649694063179853598311473820341215879965343136351436410522850717408445802043003164658348006577408558693502220285700893404674592567626297571222027902631157072143330043118418467094237965591198440803970726604537807146703763571606861448354607502654664700390453794493176794678917352634029713320615865940720837909466
`

### Diffie-Hellman starter 5

in the decrypt file we have to enter the shared secret , IV and ciphertext       
after that if you run the decrypt file you will get the flag    
```
  from Crypto.Cipher import AES
from Crypto.Util.Padding import pad, unpad
import hashlib


def is_pkcs7_padded(message):
    padding = message[-message[-1]:]
    return all(padding[i] == len(padding) for i in range(0, len(padding)))


def decrypt_flag(shared_secret: int, iv: str, ciphertext: str):
    # Derive AES key from shared secret
    sha1 = hashlib.sha1()
    sha1.update(str(shared_secret).encode('ascii'))
    key = sha1.digest()[:16]
    # Decrypt flag
    ciphertext = bytes.fromhex(ciphertext)
    iv = bytes.fromhex(iv)
    cipher = AES.new(key, AES.MODE_CBC, iv)
    plaintext = cipher.decrypt(ciphertext)

    if is_pkcs7_padded(plaintext):
        return unpad(plaintext, 16).decode('ascii')
    else:
        return plaintext.decode('ascii')

g = 2
p = 2410312426921032588552076022197566074856950548502459942654116941958108831682612228890093858261341614673227141477904012196503648957050582631942730706805009223062734745341073406696246014589361659774041027169249453200378729434170325843778659198143763193776859869524088940195577346119843545301547043747207749969763750084308926339295559968882457872412993810129130294592999947926365264059284647209730384947211681434464714438488520940127459844288859336526896320919633919
A = 112218739139542908880564359534373424013016249772931962692237907571990334483528877513809272625610512061159061737608547288558662879685086684299624481742865016924065000555267977830144740364467977206555914781236397216033805882207640219686011643468275165718132888489024688846101943642459655423609111976363316080620471928236879737944217503462265615774774318986375878440978819238346077908864116156831874695817477772477121232820827728424890845769152726027520772901423784
b = 197395083814907028991785772714920885908249341925650951555219049411298436217190605190824934787336279228785809783531814507661385111220639329358048196339626065676869119737979175531770768861808581110311903548567424039264485661330995221907803300824165469977099494284722831845653985392791480264712091293580274947132480402319812110462641143884577706335859190668240694680261160210609506891842793868297672619625924001403035676872189455767944077542198064499486164431451944
B = 1241972460522075344783337556660700537760331108332735677863862813666578639518899293226399921252049655031563612905395145236854443334774555982204857895716383215705498970395379526698761468932147200650513626028263449605755661189525521343142979265044068409405667549241125597387173006460145379759986272191990675988873894208956851773331039747840312455221354589910726982819203421992729738296452820365553759182547255998984882158393688119629609067647494762616719047466973581
shared_secret = pow (A,b,p)
iv = '737561146ff8194f45290f5766ed6aba'
ciphertext = '39c99bf2f0c14678d6a5416faef954b5893c316fc3c48622ba1fd6a9fe85f3dc72a29c394cf4bc8aff6a7b21cae8e12c'

print(decrypt_flag(shared_secret, iv, ciphertext))
```
`flag - crypto{sh4r1ng_s3cret5_w1th_fr13nd5}`

## Man In The Middle

### Parameter injection 

since we are the man in the middle , we intercept the messages and change what is written and send to the other person    
we use `nc socket.cryptohack.org 13371` to connect to server   
the data is in `json` format so we use the command `json.loads()` and `json.dumps()` to recieve and send messages   
```
import json

x = '{"p": "0xffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc740>
alice = json.loads(x)
bob = alice
bob['p'] = '1'

w = json.dumps(bob)
print (w)
```
we send the above information to bob   
we send the same information we intercepted from bob to alice without any change  

```
import json
from Crypto.Cipher import AES
from Crypto.Util import number
import hashlib

x = '{"iv": "22df5f2a1479568851fcc1d4d88bce04", "encrypted_flag": "791c890f400f766192b336d25b5264061bab2246a477cc689417e3138b9e117b"}'
alice = json.loads(x)
def decrypt(secret, iv, cipher):
    sha1 = hashlib.sha1()
    sha1.update(str(secret).encode())
    iv = bytes.fromhex(iv)
    cipher = bytes.fromhex(cipher)
    key = sha1.digest()[:16]
    aes = AES.new(key, AES.MODE_CBC, iv)
    plain = aes.decrypt(cipher)
    print(plain)

print(decrypt(0, alice['iv'], alice['encrypted_flag']))
```
`flag - crypto{n1c3_0n3_m4ll0ry!!!!!!!!}`

### Export-grade

we conncet to server using `nc socket.cryptohack.org 13379`   
we intercept alice message and directly send bob that we are using the DH64 model   
```
import json

x = '{"supported": ["DH1536", "DH1024", "DH512", "DH256", "DH128", "DH64"]}'
y = json.loads(x)

z ={"supported": ["DH64"]}
w = json.dumps(z)
print (w)
```
using we how that alice wants to use DH64 model  
we intercept the message from bob and send the same message to alice as it shows that bob has accepted DH64 model   
```
from Crypto.Cipher import AES
from Crypto.Util.Padding import unpad
import hashlib

def is_pkcs7_padded(message):
    padding = message[-message[-1]:]
    return all(padding[i] == len(padding) for i in range(0, len(padding)))

def decrypt_flag(shared_secret: int, iv: str, ciphertext: str):
    # Derive AES key from shared secret
    sha1 = hashlib.sha1()
    sha1.update(str(shared_secret).encode('ascii'))
    key = sha1.digest()[:16]
    # Decrypt flag
    ciphertext = bytes.fromhex(ciphertext)
    iv = bytes.fromhex(iv)
    cipher = AES.new(key, AES.MODE_CBC, iv)
    plaintext = cipher.decrypt(ciphertext)

    if is_pkcs7_padded(plaintext):
        return unpad(plaintext, 16).decode('ascii')
    else:
        return plaintext.decode('ascii')
p = 0xde26ab651b92a129
g = 2
A = 0x7a71ac05710cff09
B = 0x89cc61c25359649e
iv = 0x9b6406d46915e213646a66e0f2cde6cb
encrypted_flag = 0x4e9968b7fc99a860720edb39916d299de5cac8c282fa9b2341a9e287a662c784
a = 3386506623279806682
shared_secret = pow(B, a, p)

s, i, e = shared_secret, hex(iv)[2:], hex(encrypted_flag)[2:]
print(decrypt_flag(s, i, e))
```
`flag - crypto{d0wn6r4d35_4r3_d4n63r0u5}`

### Static Client

shared_key = A^b mod p  
to bob we send    
fake_B = fake_g ^b mod fake_p where fake_g = A and we get fake_b = key    

we send the output of this to bob   
```
import json

alice =  '{"p": "0xffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67>
bob = '{"B": "0x8d79b69390f639501d81bdce911ec9defb0e93d421c02958c8c8dd4e245e61a>
Alice = '{"iv": "635902c01c79c6e0c422bdeec4446bc1", "encrypted": "24376ef65e69f>
x = json.loads(Alice)

iv = '635902c01c79c6e0c422bdeec4446bc1'
ciphertext = '24376ef65e69f75efff64f59e082932fa14d137f1274afd0801d3b050ff43515'

y = json.loads(alice)
tmp = y['A']
y['A'] = y['g']
y['g'] = tmp
z = json.dumps(y)

print(z)
```
```
import json
from Crypto.Cipher import AES
from Crypto.Util.Padding import pad, unpad
import hashlib

def is_pkcs7_padded(message):
    padding = message[-message[-1]:]
    return all(padding[i] == len(padding) for i in range(0, len(padding)))

def decrypt_flag(shared_secret: int, iv: str, ciphertext: str):
    # Derive AES key from shared secret
    sha1 = hashlib.sha1()
    sha1.update(str(shared_secret).encode('ascii'))
    key = sha1.digest()[:16]
    # Decrypt flag
    ciphertext = bytes.fromhex(ciphertext)
    iv = bytes.fromhex(iv)
    cipher = AES.new(key, AES.MODE_CBC, iv)
    plaintext = cipher.decrypt(ciphertext)

    if is_pkcs7_padded(plaintext):
        return unpad(plaintext, 16).decode('ascii')
    else:
        return plaintext.decode('ascii')

alice = '{"p": "0xffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df>
y = json.loads(alice)
bob = '{"B": "0x2467c146bc7d669ea8b5cfbca20dd453c3c5d9f38f2ce7269b89c1bcf0f59b243643211111a863c539494a44b687c8e7966ec99b16b530588ec8955396a>
z = json.loads(bob)

iv = '635902c01c79c6e0c422bdeec4446bc1'
ciphertext = '24376ef65e69f75efff64f59e082932fa14d137f1274afd0801d3b050ff43515'

tmp = y['g']
y['g'] = y['A']
y['A'] = tmp

shared_secret = int(z['B'], 16)
print(decrypt_flag(shared_secret, iv, ciphertext))
```
`flag - crypto{n07_3ph3m3r4l_3n0u6h}`

## Group Theory 

### Additive

in multiplicative group you multiply multiple times and hence get `g^a` and `g^b`   
but in additive group you add repeatedly to get `g*a` and `g*b`  
hence the shared secret becomes `g*a*b mod N`    
```
from Crypto.Cipher import AES
from Crypto.Util.Padding import pad, unpad
import hashlib


def is_pkcs7_padded(message):
    padding = message[-message[-1]:]
    return all(padding[i] == len(padding) for i in range(0, len(padding)))


def decrypt_flag(shared_secret: int, iv: str, ciphertext: str):
    # Derive AES key from shared secret
    sha1 = hashlib.sha1()
    sha1.update(str(shared_secret).encode('ascii'))
    key = sha1.digest()[:16]
    # Decrypt flag
    ciphertext = bytes.fromhex(ciphertext)
    iv = bytes.fromhex(iv)
    cipher = AES.new(key, AES.MODE_CBC, iv)
    plaintext = cipher.decrypt(ciphertext)

    if is_pkcs7_padded(plaintext):
        return unpad(plaintext, 16).decode('ascii')
    else:
        return plaintext.decode('ascii')

p = int('0xffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a637ed6b0bff5cb6f406b7edee386bfb5a899fa5ae9f24117c4b1fe649286651ece45b3dc2007cb8a163bf0598da48361c55d39a69163fa8fd24cf5f83655d23dca3ad961c62f356208552bb9ed529077096966d670c354e4abc9804f1746c08ca237327ffffffffffffffff',16)
g = int('0x02',16)
A = int('0x3b6e8607bd606ce59f8c9b36068d92bf73ac5f082843b0efb7e2c843ffca9d029ad196e4a33a6b9cb5349bd9feee695faef4775dea4bf515afd45ed0cb4f0e17cad6bf746ce3c1b857a18170708f9b3de01c463dc0b1a2225092391c7b7cd177d6912c79903ae5bda42db4d0bebb9adb961a94532c81511533c4a88fe516e77765a32f721830e207307baaec8854b1b7707fdde5d8f32e97939cb79b00a511f556dfb860000ec885eca4b693bb2cd6274ce99d628e567176209a56b732d65feb',16)
B = int('0x7de30218d5332a0c60e0c3e1ec88f6142b36ce4c7c5a6fa408584e085b3bb875b6b978338d413ada42d0e42a87b083d5dd0766534a84a2d6194e51387f034511834a936de250588d5d14f33443a8ebe53be7a28f4bb734465f8f8105584fc0111c53d844890bfc3c8726a34c11517e39f1a49264b7a3bc8f2a002bbdfbbfb554503dae57db207ce0f0280d20ea5bed4546feb03f6293a5dacc728e9f99d9868792ad0e10937524b4c1c0142b70d79547bd310faae25792dc220373e2dd7484d7',16)
iv = '4d44d025d003a1c3a1f8a4631607fc15'


a = A * pow(g,-1,p)
b = B * pow(g,-1,p)

shared_secret = (g*a*b)%p

ciphertext = '76291ed8140b0a61b3f633792f83ef610bd2e84c7c6877d34c41ad070e0aeb128db9977b0e088eeb9d9a2bb235834c6f'

print(decrypt_flag(shared_secret, iv, ciphertext))
```
`flag - crypto{cycl1c_6r0up_und3r_4dd1710n?}`
